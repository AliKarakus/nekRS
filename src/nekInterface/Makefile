ifndef NEKRS_NEK5000_DIR
$(error "Error, environment variable [NEKRS_NEK5000_DIR] is not set")
endif

ifndef NEKRS_WORKING_DIR
$(error "Error, environment variable [NEKRS_WORKING_DIR] is not set")
endif

ifndef NEKRS_NEKINTERFACE_DIR
$(error "Error, environment variable [NEKRS_NEKINTERFACE_DIR] is not set")
endif

## Use the Nek5000 makefile generated by nekconfig in working dir
include ${NEKRS_WORKING_DIR}/makefile

left:= (
right:= )
USR_LFLAGS_:=$(shell echo $(USR_LFLAGS) | sed -E "s@-L$(left)[^ ]+$(right)@-Wl,-rpath,\1 -L\1@g")

NI_LDFLAGS = $(LDFLAGS) -Wl,-rpath,. -L. -lnek5000 -ldl $(USR_LFLAGS_)

nek: lib usrfile

nekInterface: nek $(NEKRS_NEKINTERFACE_DIR)/nekInterface.f
	$(FC) $(FL2) -c $(NEKRS_NEKINTERFACE_DIR)/nekInterface.f
	$(FC) $(FL2) -shared -o lib$(CASENAME).so $(CASENAME).o nekInterface.o $(NI_LDFLAGS)
